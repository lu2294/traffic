"use strict";function GLTFUtil(){}function makeLabelCanvas(t,e,r,a){var i=document.createElement("canvas").getContext("2d"),n=e+"px bold sans-serif";i.font=n;var o=i.measureText(r).width,s=t+4,l=e+4;i.canvas.width=s,i.canvas.height=l,i.font=n,i.textBaseline="middle",i.textAlign="center",0==a?i.fillStyle="blue":1==a?i.fillStyle="#00cc66":2==a?i.fillStyle="#ff9900":3==a?i.fillStyle="white":4==a&&(i.fillStyle="black"),i.fillRect(0,0,s,l);var c=Math.min(1,t/o);return i.translate(s/2,l/2),i.scale(c,1),i.fillStyle="white",3==a?i.fillStyle="black":2==a?i.fillStyle="black":1==a&&(i.fillStyle="black"),i.fillText(r,0,0),i.canvas}function DateTimeUtil(){}function TrackerPoint(){this.gpsTime=0,this.x=0,this.y=0,this.mercatorX=0,this.mercatorX=0,this.speed=0,this.direction=0,this.angle=0,this.segLength}function CarTracker(){this.trPoints=new Array,this.carid=null,this.plate=null,this.plateClass=0,this.carType=0}function CarTrackerColleciton(){this.carTrackers={}}function MapCarObject(){this.name="",this.meshModel=null,this.trackerPoint=null}function CarSceneModels(){this.modelLibs={},this.carModels={}}function MapRenderUtils(){this.mapCenter=null,this.sceneAsMercatorCoordinate=null,this.scale=0}function doLoopAnimator(t){var e=Date.now(),r=e-simController.lastDrawTime;if(r>simConfig.TIME_PERFRAME){simController.lastDrawTime=e;var a=!1;if(simController.isPause?a=!0:simController.isPlayOver()&&(a=!0),simController.isLoading&&(a=!0),!a){simController.nextToTimeMill(r*simController.replaySpeed);var i=!1,n=0,o=0;if(0==simController.dataDateTime_start?(i=!0,n=simController.startSimDate.getTime(),o=simController.startSimDate.getTime()+1e3*simConfig.DATA_REQUEST_INTELVAL):simController.dataDateTime_end-simController.playTimeMill<1e3*simConfig.PRE_REQUESTTIME?(i=!0,n=simController.dataDateTime_end,o=simController.dataDateTime_end+1e3*simConfig.DATA_REQUEST_INTELVAL):simController.playTimeMill<simController.dataDateTime_start&&(i=!0,n=simController.playTimeMill-6e4,o=n+1e3*simConfig.DATA_REQUEST_INTELVAL),i){var s=map.getCenter().lng-.02,l=map.getCenter().lng+.02,c=map.getCenter().lat-.02,m=map.getCenter().lat+.02,p=simConfig.REQUEST_SVR+"?starttime="+DateTimeUtil.date2Str(new Date(n-6e4))+"&endtime="+DateTimeUtil.date2Str(new Date(o+6e4));p=p+"&xmin="+s+"&ymin="+c+"&xmax="+l+"&ymax="+m,console.log(p),simController.isLoading=!0;$.ajax({url:p,success:function(t){cars.setWithNetReturn(simCarLayer.scene,sceneCarModels,t),simController.isLoading=!1}}),simController.dataDateTime_start=n,simController.dataDateTime_end=o}else{var T=cars.getCarStatesSnap(simController.playTimeMill);sceneCarModels.updateModelState(simCarLayer.scene,T),map.triggerRepaint(),simController.timeUpdateFunction&&simController.timeUpdateFunction(simController.playTimeMill)}}}requestAnimationFrame(doLoopAnimator)}function SimConfig(){this.TIME_PERFRAME=30,this.PRE_REQUESTTIME=3,this.DATA_REQUEST_INTELVAL=300,this.REQUEST_SVR="http://localhost:8080/urbansimulator/CarTrackerSvr"}function SimController(){this.isLoading=!1,this.isPause=!1,this.startSimDate=0,this.playTimeMill=0,this.lastDrawTime=Date.now(),this.replaySpeed=1,this.dataDateTime_start=0,this.dataDateTime_end=0,this.maxDuringTime=6e5}var VALID_MIN_TIMEDISTANCE=5e3;GLTFUtil.prototype.getMeshObj=function(t,e){return t.traverse(function(t){null==this.findObj&&t instanceof THREE.Mesh&&t.name==e&&(this.findObj=t)}.bind(this)),this.findObj},DateTimeUtil.str2Date=function(t){var t=t.split(","),e=parseInt(t[0].substr(0,4)),r=parseInt(t[0].substr(4,2)),a=parseInt(t[0].substr(6,2)),i=parseInt(t[0].substr(8,2)),n=parseInt(t[0].substr(10,2)),o=parseInt(t[0].substr(12,2)),s=parseInt(t[0].substr(14,3));return new Date(e,r-1,a,i,n,o,s)},DateTimeUtil.num2Str=function(t,e){for(var r=""+t,a=e-r.length,i=0;i<a;i++)r="0"+r;return r},DateTimeUtil.date2Str=function(t){var e=DateTimeUtil.num2Str(t.getFullYear(),4);return e+=DateTimeUtil.num2Str(t.getMonth()+1,2),e+=DateTimeUtil.num2Str(t.getDate(),2),e+=DateTimeUtil.num2Str(t.getHours(),2),e+=DateTimeUtil.num2Str(t.getMinutes(),2),e+=DateTimeUtil.num2Str(t.getSeconds(),2)},DateTimeUtil.date2StrDisplay=function(t){var e=DateTimeUtil.num2Str(t.getFullYear(),4);return e+="/",e+=DateTimeUtil.num2Str(t.getMonth()+1,2),e+="/",e+=DateTimeUtil.num2Str(t.getDate(),2),e+="  ",e+=DateTimeUtil.num2Str(t.getHours(),2),e+=":",e+=DateTimeUtil.num2Str(t.getMinutes(),2),e+=":",e+=DateTimeUtil.num2Str(t.getSeconds(),2)},TrackerPoint.prototype.setWithStr=function(t){var e=t.split(",");this.gpsTime=DateTimeUtil.str2Date(e[0]).getTime(),this.x=1*e[1],this.y=1*e[2],this.speed,e[3],this.angle=1*e[4];var r=[this.x,this.y],a=amapgl.MercatorCoordinate.fromLngLat(r,0);this.mercatorX=a.x,this.mercatorY=a.y,this.speed=1*e[3]},CarTracker.prototype.addTrackerPoint=function(t){var e=new TrackerPoint;e.setWithStr(t),this.trPoints.push(e)},CarTracker.prototype.getInterPoint=function(t){for(var e=1;e<this.trPoints.length;e++){var r=this.trPoints[e];if(r.gpsTime>=t){var a=this.trPoints[e-1];if(a.gpsTime>t)return null;if(r.gpsTime==a.gpsTime)return a;var i=new TrackerPoint,n=t-a.gpsTime,o=r.gpsTime-a.gpsTime,s=n/o;i.mercatorX=a.mercatorX+(r.mercatorX-a.mercatorX)*s,i.mercatorY=a.mercatorY+(r.mercatorY-a.mercatorY)*s,i.gpsTime=t,i.speed=r.speed;var l=new THREE.Vector2(a.mercatorX-r.mercatorX,a.mercatorY-r.mercatorY),c=180*l.angle()/Math.PI+180;return c>180?c=360-c:c<-180&&(c=360+c),i.angle=c,i}}return null},CarTrackerColleciton.prototype.addCarTracker=function(t,e){if(null!=this.carTrackers[t])for(var r=0,a=e.length;r<a;r++)this.carTrackers[t].addTrackerPoint(e.tracker[r]);else{var i=new CarTracker;i.carid=t,i.plate=e.plate,i.plateClass=e.plateclass,i.carType=e.cartype;for(var r=0,a=e.tracker.length;r<a;r++)i.addTrackerPoint(e.tracker[r]);this.carTrackers[t]=i}},CarTrackerColleciton.prototype.setWithNetReturn=function(t,e,r){for(var a in this.carTrackers)if(null==r[a]){var i=e.carModels[a];null!=i&&t.remove(i.meshModel),delete this.carTrackers[a],delete e[a]}for(var n in r)this.addCarTracker(n,r[n])},CarTrackerColleciton.prototype.getCarStatesSnap=function(t){var e={};for(var r in this.carTrackers){var a=this.carTrackers[r].getInterPoint(t),i=new CarTracker;i.trPoints=a,i.carid=r,i.plate=this.carTrackers[r].plate,i.carType=this.carTrackers[r].carType,i.plateClass=this.carTrackers[r].plateClass,null!=a&&(e[r]=i)}return e},CarSceneModels.prototype.addModel=function(t,e){this.modelLibs[t]=e},CarSceneModels.prototype.updateModelState=function(t,e){for(var r in this.carModels)null==e[r]&&(t.remove(this.carModels[r].meshModel),delete this.carModels[r]);for(var a in e){var i=(e[a].trPoints,e[a].plateClass),n=e[a].plate,o=(e[a].carType,this.carModels[a]);if(null==o){var s=new MapCarObject;s.name=a;var l=this.modelLibs.car_blue;if(null!=l){var c=new THREE.Mesh(l.geometry,new THREE.MeshPhongMaterial({color:7829503,wireframe:!1,transparent:!0,side:2}));if(s.meshModel=c,s.trackerPoint=e[a].trPoints,this.carModels[a]=s,n.length>0){var m=makeLabelCanvas(150,32,n,i),p=new THREE.CanvasTexture(m);p.minFilter=THREE.LinearFilter,p.wrapS=THREE.ClampToEdgeWrapping,p.wrapT=THREE.ClampToEdgeWrapping;var T=new THREE.SpriteMaterial({map:p,transparent:!0,opacity:.7}),h=new THREE.Sprite(T);h.position.z=300,h.scale.x=3*m.width,h.scale.y=3*m.height,s.meshModel.add(h)}t.add(s.meshModel)}}else o.trackerPoint=e[a].trPoints}},CarSceneModels.prototype.updateGLModelState=function(t,e){for(var r in this.carModels){var a=this.carModels[r];if(null!=a){var i=new THREE.Vector3(a.trackerPoint.mercatorX,a.trackerPoint.mercatorY,0);e.updateModelTranslate(t,a.meshModel,i,.012),a.meshModel.rotation.z=a.trackerPoint.angle*Math.PI/180}}},MapRenderUtils.prototype.getRenderCamera=function(t){var e=36.86989764584402,r=t.getCanvas().width/t.getCanvas().height,a=t.getCanvas().height,i=a/1024,n=new THREE.PerspectiveCamera(e,r,.001,50),o=(new THREE.Matrix4).makeRotationAxis(new THREE.Vector3(1,0,0),t.getPitch()*Math.PI/180),s=(new THREE.Matrix4).makeRotationAxis(new THREE.Vector3(0,0,1),-t.getBearing()*Math.PI/180),l=s.multiply(o),c=new THREE.Vector3(0,1,0),m=amapgl.MercatorCoordinate.fromLngLat(t.getCenter()),p=m.meterInMercatorCoordinateUnits(),T=t.painter.transform.zoom,h=1;T>=16?(T-=16,h=65536,p*=h):T>=8?(T-=8,h=256,p*=h):(h=1,p*=h);var d=.5/Math.tan(e*Math.PI/360);d/=Math.pow(2,T),d*=i;var u=new THREE.Vector3(0,0,d);return c=c.clone().applyMatrix4(l),u=u.clone().applyMatrix4(l),n.position.x=u.x,n.position.y=u.y,n.position.z=u.z,n.up=c,n.lookAt(0,0,0),n.updateProjectionMatrix(),n},MapRenderUtils.prototype.updateModelTranslate=function(t,e,r,a){var i=1,n=amapgl.MercatorCoordinate.fromLngLat(t.getCenter()),o=n.meterInMercatorCoordinateUnits(),s=t.painter.transform.zoom;s>=16?(s-=16,i=65536,o*=i,e.scale.x=o*a,e.scale.y=o*a,e.scale.z=o*a,e.position.x=(r.x-n.x)*i,e.position.y=-(r.y-n.y)*i,e.position.z=r.z*n.meterInMercatorCoordinateUnits()*i):s>=8?(s-=8,i=256,o*=i,e.scale.x=o*a,e.scale.y=o*a,e.scale.z=o*a,e.position.x=(r.x-n.x)*i,e.position.y=-(r.y-n.y)*i,e.position.z=r.z*n.meterInMercatorCoordinateUnits()*i):(i=1,o*=i,e.scale.x=o*a,e.scale.y=o*a,e.scale.z=o*a,e.position.x=(r.x-n.x)*i,e.position.y=-(r.y-n.y)*i,e.position.z=r.z*n.meterInMercatorCoordinateUnits()*i)},MapRenderUtils.prototype.getRenderMatrix=function(t,e){this.mapCenter=t;var r=[t.lng,t.lat],a=[0,0,0];this.sceneAsMercatorCoordinate=amapgl.MercatorCoordinate.fromLngLat(r,0),this.scale=this.sceneAsMercatorCoordinate.meterInMercatorCoordinateUnits();var i={translateX:this.sceneAsMercatorCoordinate.x,translateY:this.sceneAsMercatorCoordinate.y,translateZ:this.sceneAsMercatorCoordinate.z,rotateX:a[0],rotateY:a[1],rotateZ:a[2],scale:this.sceneAsMercatorCoordinate.meterInMercatorCoordinateUnits()},n=(new THREE.Matrix4).makeRotationAxis(new THREE.Vector3(1,0,0),i.rotateX),o=(new THREE.Matrix4).makeRotationAxis(new THREE.Vector3(0,1,0),i.rotateY),s=(new THREE.Matrix4).makeRotationAxis(new THREE.Vector3(0,0,1),i.rotateZ),l=(new THREE.Matrix4).fromArray(e),c=(new THREE.Matrix4).makeTranslation(i.translateX,i.translateY,i.translateZ).scale(new THREE.Vector3(i.scale,-i.scale,i.scale)).multiply(n).multiply(o).multiply(s);return l.multiply(c)},SimController.prototype.pause=function(){this.isPause=!0},SimController.prototype.resume=function(){this.isPause=!1},SimController.prototype.resetState=function(){this.playTimeMill=this.startSimDate.getTime(),this.lastDrawTime=Date.now()},SimController.prototype.nextToTimeMill=function(t){this.playTimeMill=this.playTimeMill+t},SimController.prototype.getPlayDateTM=function(){return this.playTimeMill},SimController.prototype.getPlayedTime=function(){var t=this.playTimeMill-this.startSimDate.getTime();return t<0&&(t=0),t},SimController.prototype.setTimeUpdateListener=function(t){this.timeUpdateFunction=t},SimController.prototype.setPlayOffsetTime=function(t){this.playTimeMill=this.startSimDate.getTime()+t},SimController.prototype.isPlayOver=function(){return this.playTimeMill>=this.startSimDate.getTime()+this.maxDuringTime},SimController.prototype.clearData=function(){if(this.playTimeMill>this.dataDateTime_end){for(var t in cars.carTrackers)delete cars.carTrackers[t];for(var e in sceneCarModels.carModels){var r=sceneCarModels.carModels[e];simCarLayer.scene.remove(r.meshModel),delete sceneCarModels.carModels[e]}}};